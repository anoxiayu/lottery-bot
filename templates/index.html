<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤§ä¹é€ç®¡å®¶</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f0f2f5;
            --red-ball-grad: radial-gradient(circle at 30% 30%, #ff7675, #d63031);
            --blue-ball-grad: radial-gradient(circle at 30% 30%, #74b9ff, #0984e3);
            --header-grad: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        }
        body { background-color: var(--bg-color); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; padding-bottom: 80px; color: #2d3436; }
        .main-box { max-width: 600px; margin: 0 auto; }
        .navbar { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(0,0,0,0.05); }
        .header-card { background: var(--header-grad); border-radius: 20px; padding: 25px 20px; color: white; box-shadow: 0 10px 30px rgba(30, 60, 114, 0.3); position: relative; overflow: hidden; }
        .header-card::before { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 60%); pointer-events: none; }
        .term-tag { background: rgba(255, 255, 255, 0.2); padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.2); }
        .prize-pool { font-size: 1.4rem; font-weight: 800; background: linear-gradient(to bottom, #ffeaa7, #fab1a0); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 0 2px 10px rgba(0,0,0,0.2); margin-top: 8px; }
        .ball { display: inline-flex; justify-content: center; align-items: center; width: 34px; height: 34px; border-radius: 50%; font-size: 14px; font-weight: bold; margin: 3px; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.3); box-shadow: 0 4px 8px rgba(0,0,0,0.15), inset 0 2px 2px rgba(255,255,255,0.4); border: 1px solid rgba(255,255,255,0.2); }
        .hit-r { background: var(--red-ball-grad); transform: scale(1.1); z-index: 2; }
        .hit-b { background: var(--blue-ball-grad); transform: scale(1.1); z-index: 2; }
        .miss { background: #dfe6e9; color: #b2bec3; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1); border: none; text-shadow: none; }
        .content-card { background: white; border-radius: 16px; border: none; box-shadow: 0 8px 24px rgba(149, 157, 165, 0.1); overflow: hidden; margin-bottom: 20px; }
        .card-header-custom { background: white; padding: 15px 20px; border-bottom: 1px solid #f1f2f6; }
        .ticket-item { padding: 15px 20px; border-bottom: 1px solid #f5f6fa; position: relative; }
        .win-bg { background-color: #fffcf0; }
        .win-bg::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: #ff9f43; border-top-right-radius: 4px; border-bottom-right-radius: 4px; }
        .expired-item { opacity: 0.6; filter: grayscale(0.9); background: #fafafa; }
        
        .input-group-balls { display: flex; justify-content: center; gap: 8px; margin-bottom: 20px; }
        .input-ball { width: 52px; height: 52px; text-align: center; border-radius: 12px; border: 2px solid #dfe6e9; font-weight: bold; font-size: 20px; background: #fff; transition: all 0.2s; }
        .input-ball:focus { border-color: #74b9ff; outline: none; box-shadow: 0 0 0 4px rgba(116, 185, 255, 0.2); transform: translateY(-2px); }
        .input-red { color: #d63031; background: #fff5f5; }
        .input-red:focus { border-color: #ff7675; box-shadow: 0 0 0 4px rgba(255, 118, 117, 0.2); }
        .input-blue { color: #0984e3; background: #f0f8ff; }
        .btn-add-main { background: linear-gradient(to right, #0984e3, #74b9ff); border: none; box-shadow: 0 4px 12px rgba(9, 132, 227, 0.3); }
        .btn-check-now { background: #ff4757; border: none; color: white; box-shadow: 0 4px 10px rgba(255, 71, 87, 0.3); }
        .btn-rules { background: #20bf6b; border: none; color: white; box-shadow: 0 4px 10px rgba(32, 191, 107, 0.3); }
        .badge-custom { font-weight: 500; padding: 5px 10px; border-radius: 6px; }
        /* å¼€å…³æ ·å¼ */
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .3s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .3s; border-radius: 50%; }
        input:checked + .slider { background-color: #27ae60; }
        input:checked + .slider:before { transform: translateX(20px); }
        .simulation-card { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .sim-badge { background: rgba(255,255,255,0.3); color: white; font-size: 0.7rem; padding: 2px 8px; border-radius: 10px; }
        .btn-random { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; color: white; }
        .btn-camera { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); border: none; color: white; }
        .camera-preview { width: 100%; max-height: 300px; object-fit: cover; border-radius: 12px; display: none; }
        .ocr-result { background: #f8f9fa; border-radius: 12px; padding: 15px; margin-top: 15px; }
        .ocr-ticket { background: white; border-radius: 8px; padding: 10px; margin-bottom: 10px; border: 1px solid #e9ecef; }
        .random-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 16px; padding: 20px; color: white; margin-bottom: 20px; }
        .random-ball { width: 42px; height: 42px; border-radius: 50%; display: inline-flex; justify-content: center; align-items: center; font-weight: bold; font-size: 16px; margin: 4px; color: white; box-shadow: 0 3px 8px rgba(0,0,0,0.2); }
        .random-ball.red { background: linear-gradient(135deg, #ff6b6b, #ee5a52); }
        .random-ball.blue { background: linear-gradient(135deg, #74b9ff, #0984e3); }
        .btn-action { font-size: 0.8rem; padding: 4px 10px; border-radius: 6px; text-decoration: none; display: inline-block; }
        .btn-history { background: #3498db; color: white; }
        .btn-edit { background: #f39c12; color: white; }
        .btn-del { background: #e74c3c; color: white; }
        .ocr-loading { text-align: center; padding: 20px; }
        .ocr-loading .spinner-border { width: 3rem; height: 3rem; }
    </style>
</head>
<body>

<nav class="navbar fixed-top">
    <div class="container main-box d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center">
            <div style="width: 8px; height: 8px; background: #2ecc71; border-radius: 50%; margin-right: 8px;"></div>
            <span class="fw-bold text-dark">{{ user.username }}</span>
            {% if is_admin %}
            <span class="badge bg-danger ms-2" style="font-size: 0.7rem;">Admin</span>
            {% endif %}
        </div>
        <div>
            {% if is_admin %}
            <a href="/admin" class="text-danger text-decoration-none me-3" style="font-size: 0.9rem;"><i class="fas fa-cogs me-1"></i>ç®¡ç†åå°</a>
            {% endif %}
            <span class="text-secondary me-3" style="font-size: 0.9rem;"><i class="fas fa-users me-1"></i>æ³¨å†Œ: {{ user_count }}</span>
            <a href="/logout" class="text-secondary text-decoration-none" style="font-size: 0.9rem;"><i class="fas fa-sign-out-alt"></i> é€€å‡º</a>
        </div>
    </div>
</nav>

<div class="container main-box" style="margin-top: 70px;">
    {% with messages = get_flashed_messages() %}
      {% if messages %}<div class="alert alert-success shadow-sm border-0 rounded-3 text-center py-2 mb-4" style="font-size: 0.9rem;">{{ messages[0] }}</div>{% endif %}
    {% endwith %}
    
    <div class="header-card mb-4 text-center">
        {% if latest %}
            <input type="hidden" id="latestTerm" value="{{ latest.term }}">
            <div class="d-flex justify-content-between align-items-center mb-3 px-2">
                <span class="term-tag">ç¬¬ {{ latest.term }} æœŸ</span>
                <span style="font-size: 0.85rem; opacity: 0.8;">{{ latest.date }}</span>
            </div>
            <div class="d-flex justify-content-center align-items-center my-3">
                {% for n in latest.red %} <span class="ball hit-r">{{n}}</span> {% endfor %}
                <span style="width: 15px"></span>
                {% for n in latest.blue %} <span class="ball hit-b">{{n}}</span> {% endfor %}
            </div>
            <div class="small text-white opacity-75">æœ¬æœŸå¥–æ± æ»šå­˜</div>
            <div class="prize-pool">{{ "{:,.0f}".format(latest.pool|float) }} <span style="font-size: 1rem; color: white;">å…ƒ</span></div>
        {% else %}
            <input type="hidden" id="latestTerm" value="0">
            <div class="py-4 opacity-75"><div class="spinner-border text-light mb-2" role="status"></div><div>æ­£åœ¨åŒæ­¥ä½“å½©æ•°æ®...</div></div>
        {% endif %}
    </div>

    <!-- éšæœºå·ç ç”Ÿæˆæ¨¡å— -->
    {% if user.enable_random_generator %}
    <div class="random-card">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="m-0 fw-bold"><i class="fas fa-dice me-2"></i>éšæœºå·ç ç”Ÿæˆå™¨</h6>
            <button class="btn btn-light btn-sm rounded-pill px-3 fw-bold" onclick="generateRandomDisplay()">
                <i class="fas fa-sync-alt me-1"></i>é‡æ–°ç”Ÿæˆ
            </button>
        </div>
        <div class="text-center py-2" id="randomNumbersDisplay">
            <div class="mb-2">
                <span class="random-ball red" id="rand_r1">--</span>
                <span class="random-ball red" id="rand_r2">--</span>
                <span class="random-ball red" id="rand_r3">--</span>
                <span class="random-ball red" id="rand_r4">--</span>
                <span class="random-ball red" id="rand_r5">--</span>
                <span class="mx-2 text-white">+</span>
                <span class="random-ball blue" id="rand_b1">--</span>
                <span class="random-ball blue" id="rand_b2">--</span>
            </div>
        </div>
        <div class="text-center mt-2">
            <button class="btn btn-outline-light btn-sm rounded-pill px-4" onclick="useRandomNumbers()">
                <i class="fas fa-arrow-right me-1"></i>ä½¿ç”¨è¿™ç»„å·ç 
            </button>
        </div>
    </div>
    {% endif %}

    <div class="content-card mb-4">
        <div class="card-header-custom d-flex justify-content-between align-items-center">
            <h6 class="m-0 fw-bold text-dark"><i class="fas fa-ticket-alt text-primary me-2"></i>æˆ‘çš„å½©ç¥¨</h6>
            <div class="d-flex gap-2">
                <button class="btn btn-sm btn-camera rounded-pill px-3" data-bs-toggle="modal" data-bs-target="#cameraModal"><i class="fas fa-camera"></i></button>
                <button class="btn btn-sm btn-primary btn-add-main rounded-pill px-4 fw-bold" data-bs-toggle="modal" data-bs-target="#addModal">+ æ·»åŠ </button>
            </div>
        </div>
        <div class="list-content">
            {% if tickets %}
                {% for item in tickets %}
                <div class="ticket-item {{ 'win-bg' if item.status.prize > 0 else '' }} {{ 'expired-item' if item.status.state == 'expired' else '' }}">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <span class="fw-bold text-dark">{{ item.ticket.note or 'è‡ªé€‰å·ç ' }}</span>
                            <span class="text-muted ms-2" style="font-size: 0.75rem;"><i class="far fa-clock"></i> {{ item.ticket.start_term }} - {{ item.ticket.end_term }}æœŸ</span>
                        </div>
                        {% if item.status.state == 'expired' %} <span class="badge-custom bg-secondary text-white" style="font-size: 10px;">å·²è¿‡æœŸ</span>
                        {% elif item.status.state == 'future' %} <span class="badge-custom bg-info text-white" style="font-size: 10px;">å¾…å¼€å¥–</span>
                        {% elif item.status.prize > 0 %} <span class="badge-custom bg-warning text-dark border border-warning shadow-sm">{{ item.status.level }} <span class="fw-bold text-danger">ï¿¥{{ item.status.prize }}</span></span>
                        {% else %} <span class="badge-custom bg-light text-secondary">æœªä¸­å¥–</span> {% endif %}
                    </div>
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center flex-wrap">
                            {% for n in item.ticket.red_nums.split(',') %} <span class="ball {{ 'hit-r' if n in item.status.hit_reds else 'miss' }}">{{ n }}</span> {% endfor %}
                            <span class="mx-1"></span>
                            {% for n in item.ticket.blue_nums.split(',') %} <span class="ball {{ 'hit-b' if n in item.status.hit_blues else 'miss' }}">{{ n }}</span> {% endfor %}
                        </div>
                    </div>
                    <div class="d-flex gap-2 mt-2 justify-content-end">
                        <a href="/history/{{ item.ticket.id }}" class="btn-action btn-history">æŸ¥çœ‹å†å²</a>
                        <a href="#" class="btn-action btn-edit" onclick="openEditModal({{ item.ticket.id }}, '{{ item.ticket.red_nums }}', '{{ item.ticket.blue_nums }}', '{{ item.ticket.note or '' }}', {{ item.ticket.start_term }}, {{ item.ticket.end_term }}, {{ 'true' if item.ticket.is_simulation else 'false' }})">ä¿®æ”¹</a>
                        <a href="/delete/{{ item.ticket.id }}" class="btn-action btn-del" onclick="return confirm('ç¡®è®¤åˆ é™¤æ­¤è®°å½•ï¼Ÿ')">åˆ é™¤</a>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="text-center py-5"><div class="mb-3 text-muted" style="font-size: 3rem;"><i class="fas fa-receipt"></i></div><p class="text-muted small">æš‚æ— è®°å½•ï¼Œç‚¹å‡»å³ä¸Šè§’æ·»åŠ æ‚¨çš„å¹¸è¿å·ç </p></div>
            {% endif %}
        </div>
    </div>

    <!-- æ¨¡æ‹Ÿè´­å½©åŒºåŸŸ -->
    {% if user.enable_simulation %}
    <div class="content-card mb-4">
        <div class="card-header-custom d-flex justify-content-between align-items-center" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
            <h6 class="m-0 fw-bold text-white"><i class="fas fa-gamepad me-2"></i>æ¨¡æ‹Ÿè´­å½©</h6>
            <span class="sim-badge">ä¸è®¡å…¥ç»Ÿè®¡</span>
        </div>
        <div class="list-content">
            {% if simulation_tickets %}
                {% for item in simulation_tickets %}
                <div class="ticket-item {{ 'win-bg' if item.status.prize > 0 else '' }} {{ 'expired-item' if item.status.state == 'expired' else '' }}">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <span class="fw-bold text-dark">{{ item.ticket.note or 'æ¨¡æ‹Ÿå·ç ' }}</span>
                            <span class="badge bg-pink text-white ms-2" style="font-size: 0.65rem; background: #f093fb;">æ¨¡æ‹Ÿ</span>
                            <span class="text-muted ms-2" style="font-size: 0.75rem;"><i class="far fa-clock"></i> {{ item.ticket.start_term }} - {{ item.ticket.end_term }}æœŸ</span>
                        </div>
                        {% if item.status.state == 'expired' %} <span class="badge-custom bg-secondary text-white" style="font-size: 10px;">å·²è¿‡æœŸ</span>
                        {% elif item.status.state == 'future' %} <span class="badge-custom bg-info text-white" style="font-size: 10px;">å¾…å¼€å¥–</span>
                        {% elif item.status.prize > 0 %} <span class="badge-custom bg-warning text-dark border border-warning shadow-sm">{{ item.status.level }} <span class="fw-bold text-danger">ï¿¥{{ item.status.prize }}</span></span>
                        {% else %} <span class="badge-custom bg-light text-secondary">æœªä¸­å¥–</span> {% endif %}
                    </div>
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center flex-wrap">
                            {% for n in item.ticket.red_nums.split(',') %} <span class="ball {{ 'hit-r' if n in item.status.hit_reds else 'miss' }}">{{ n }}</span> {% endfor %}
                            <span class="mx-1"></span>
                            {% for n in item.ticket.blue_nums.split(',') %} <span class="ball {{ 'hit-b' if n in item.status.hit_blues else 'miss' }}">{{ n }}</span> {% endfor %}
                        </div>
                    </div>
                    <div class="d-flex gap-2 mt-2 justify-content-end">
                        <a href="/history/{{ item.ticket.id }}" class="btn-action btn-history">æŸ¥çœ‹å†å²</a>
                        <a href="#" class="btn-action btn-edit" onclick="openEditModal({{ item.ticket.id }}, '{{ item.ticket.red_nums }}', '{{ item.ticket.blue_nums }}', '{{ item.ticket.note or '' }}', {{ item.ticket.start_term }}, {{ item.ticket.end_term }}, {{ 'true' if item.ticket.is_simulation else 'false' }})">ä¿®æ”¹</a>
                        <a href="/delete/{{ item.ticket.id }}" class="btn-action btn-del" onclick="return confirm('ç¡®è®¤åˆ é™¤æ­¤è®°å½•ï¼Ÿ')">åˆ é™¤</a>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="text-center py-4"><p class="text-muted small mb-2">æš‚æ— æ¨¡æ‹Ÿå½©ç¥¨</p><button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addModal" onclick="document.getElementById('isSimulation').value='1'">æ·»åŠ æ¨¡æ‹Ÿå·ç </button></div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <div class="content-card p-3">
        <div class="d-flex align-items-center mb-3"><h6 class="fw-bold m-0 flex-grow-1"><i class="fas fa-cog text-secondary me-2"></i>ç³»ç»Ÿè®¾ç½®</h6></div>
        <form action="/update_settings" method="POST">
            <label class="small text-muted fw-bold mb-1">Serveré…± Key</label>
            <input type="hidden" name="sckey_full" id="sckeyFull" value="{{ user.sckey or '' }}">
            <div class="input-group mb-3">
                <span class="input-group-text bg-light"><i class="fas fa-key text-muted"></i></span>
                <input type="text" class="form-control" id="sckeyDisplay" 
                       value="{% if user.sckey %}{{ user.sckey[:3] }}******{{ user.sckey[-4:] }}{% endif %}" 
                       placeholder="è¯·è¾“å…¥ Serveré…± Key" onfocus="showFullSckey()" onblur="hideFullSckey()">
                <input type="hidden" name="sckey" id="sckeyInput" value="">
            </div>
            <label class="small text-muted fw-bold mb-1">è‡ªåŠ¨æ¨é€æ—¶é—´ (å‘¨ä¸€/ä¸‰/å…­)</label>
            <div class="input-group mb-3">
                <span class="input-group-text bg-light"><i class="far fa-clock text-muted"></i></span>
                <input type="time" class="form-control" name="push_time" value="{{ push_time }}">
            </div>
            
            <!-- åŠŸèƒ½å¼€å…³ -->
            <div class="bg-light rounded-3 p-3 mb-3">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <i class="fas fa-trash-alt text-danger me-2"></i>
                        <span class="fw-bold">è¿‡æœŸè‡ªåŠ¨åˆ é™¤</span>
                        <div class="text-muted small">è‡ªåŠ¨åˆ é™¤å·²è¿‡æœŸçš„å½©ç¥¨è®°å½•</div>
                    </div>
                    <label class="switch">
                        <input type="checkbox" name="auto_delete_expired" {{ 'checked' if user.auto_delete_expired else '' }}>
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <i class="fas fa-gamepad text-primary me-2"></i>
                        <span class="fw-bold">æ¨¡æ‹Ÿè´­å½©æ¨¡å¼</span>
                        <div class="text-muted small">å¼€å¯åå¯æ·»åŠ æ¨¡æ‹Ÿå½©ç¥¨</div>
                    </div>
                    <label class="switch">
                        <input type="checkbox" name="enable_simulation" {{ 'checked' if user.enable_simulation else '' }}>
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-dice text-purple me-2" style="color: #764ba2;"></i>
                        <span class="fw-bold">éšæœºå·ç ç”Ÿæˆå™¨</span>
                        <div class="text-muted small">å¼€å¯åæ˜¾ç¤ºéšæœºå·ç æ¨¡å—</div>
                    </div>
                    <label class="switch">
                        <input type="checkbox" name="enable_random_generator" {{ 'checked' if user.enable_random_generator else '' }}>
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
            
            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-dark flex-grow-1">ä¿å­˜è®¾ç½®</button>
                <a href="/rules" class="btn btn-rules flex-grow-1 fw-bold"><i class="fas fa-book-open me-2"></i>ä¸­å¥–è§„åˆ™</a>
                <a href="/trigger_self" class="btn btn-check-now flex-grow-1 fw-bold"><i class="fas fa-rocket me-2"></i>ç«‹å³æ¨é€</a>
            </div>
        </form>
    </div>
    <div class="text-center mt-4 text-muted" style="font-size: 0.75rem; opacity: 0.6;">Lottery Assistant V7.8</div>
</div>

<div class="modal fade" id="addModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg" style="border-radius: 20px;">
      <div class="modal-header border-0 pb-0"><h5 class="modal-title fw-bold ps-2">ğŸ² æ·»åŠ å·ç </h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body pt-4">
        <form action="/add" method="POST" id="ballForm">
            <input type="hidden" name="is_simulation" id="isSimulation" value="0">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="mb-2 text-muted small fw-bold ps-2">å‰åŒº (çº¢çƒ)</div>
            </div>
            <div class="input-group-balls">{% for i in range(1,6) %}<input type="tel" class="input-ball input-red jump-input" name="r{{i}}" id="r{{i}}" maxlength="2" required autocomplete="off">{% endfor %}</div>
            <div class="mb-2 text-muted small fw-bold ps-2">ååŒº (è“çƒ)</div>
            <div class="input-group-balls">{% for i in range(1,3) %}<input type="tel" class="input-ball input-blue jump-input" name="b{{i}}" id="b{{i}}" maxlength="2" required autocomplete="off">{% endfor %}</div>
            <hr class="my-4 opacity-10">
            <div class="bg-light p-3 rounded-3 mb-3">
                <div class="row g-2 align-items-center">
                    <div class="col-4"><label class="small text-muted d-block">å¼€å§‹æœŸå·</label><input type="number" class="form-control border-0 shadow-sm" name="start_term" id="startTerm" required style="font-weight: bold;"></div>
                    <div class="col-4"><label class="small text-muted d-block">è¿ä¹°(æœŸ)</label>
                        <input type="number" class="form-control border-0 shadow-sm text-center text-primary fw-bold" id="termCount" value="1" min="1" max="20" required>
                    </div>
                    <div class="col-4"><label class="small text-muted d-block">ç»“æŸæœŸå·</label><input type="number" class="form-control border-0 bg-white shadow-sm text-muted" name="end_term" id="endTerm" readonly tabindex="-1"></div>
                </div>
            </div>
            {% if user.enable_simulation %}
            <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="simCheck" onchange="document.getElementById('isSimulation').value = this.checked ? '1' : '0'">
                <label class="form-check-label" for="simCheck"><i class="fas fa-gamepad text-primary me-1"></i>æ·»åŠ ä¸ºæ¨¡æ‹Ÿè´­å½©</label>
            </div>
            {% endif %}
            <div class="mb-3"><input type="text" class="form-control py-2 rounded-3" name="note" placeholder="å¤‡æ³¨ (ä¾‹å¦‚: è€å©†ç”Ÿæ—¥å·)"></div>
            <button type="submit" class="btn btn-primary w-100 py-3 rounded-3 fw-bold shadow-sm btn-add-main">ç¡®è®¤ä¿å­˜</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- ç¼–è¾‘å½©ç¥¨å¼¹çª— -->
<div class="modal fade" id="editModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg" style="border-radius: 20px;">
      <div class="modal-header border-0 pb-0"><h5 class="modal-title fw-bold ps-2">âœï¸ ä¿®æ”¹å½©ç¥¨</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body pt-4">
        <form action="/edit_ticket" method="POST" id="editForm">
            <input type="hidden" name="ticket_id" id="editTicketId">
            <input type="hidden" name="is_simulation" id="editIsSimulation" value="0">
            <div class="mb-2 text-muted small fw-bold ps-2">å‰åŒº (çº¢çƒ)</div>
            <div class="input-group-balls">{% for i in range(1,6) %}<input type="tel" class="input-ball input-red edit-jump-input" name="edit_r{{i}}" id="edit_r{{i}}" maxlength="2" required autocomplete="off">{% endfor %}</div>
            <div class="mb-2 text-muted small fw-bold ps-2">ååŒº (è“çƒ)</div>
            <div class="input-group-balls">{% for i in range(1,3) %}<input type="tel" class="input-ball input-blue edit-jump-input" name="edit_b{{i}}" id="edit_b{{i}}" maxlength="2" required autocomplete="off">{% endfor %}</div>
            <hr class="my-4 opacity-10">
            <div class="bg-light p-3 rounded-3 mb-3">
                <div class="row g-2 align-items-center">
                    <div class="col-6"><label class="small text-muted d-block">å¼€å§‹æœŸå·</label><input type="number" class="form-control border-0 shadow-sm" name="edit_start_term" id="editStartTerm" required style="font-weight: bold;"></div>
                    <div class="col-6"><label class="small text-muted d-block">ç»“æŸæœŸå·</label><input type="number" class="form-control border-0 shadow-sm" name="edit_end_term" id="editEndTerm" required style="font-weight: bold;"></div>
                </div>
            </div>
            <div class="mb-3"><input type="text" class="form-control py-2 rounded-3" name="edit_note" id="editNote" placeholder="å¤‡æ³¨"></div>
            <button type="submit" class="btn btn-warning w-100 py-3 rounded-3 fw-bold shadow-sm">ä¿å­˜ä¿®æ”¹</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- æ‹ç…§ä¸Šä¼ å¼¹çª— -->
<div class="modal fade" id="cameraModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg" style="border-radius: 20px;">
      <div class="modal-header border-0 pb-0"><h5 class="modal-title fw-bold ps-2">ğŸ“· æ‹ç…§æ·»åŠ å½©ç¥¨</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body pt-4">
        <!-- æ‹ç…§å¼•å¯¼æç¤º -->
        <div class="alert alert-warning py-2 mb-3" id="photoGuide">
            <div class="fw-bold mb-1"><i class="fas fa-lightbulb me-1"></i>æ‹ç…§å°æŠ€å·§</div>
            <ul class="small mb-0 ps-3">
                <li>ç¡®ä¿å…‰çº¿å……è¶³ï¼Œé¿å…é˜´å½±é®æŒ¡</li>
                <li>å°†å½©ç¥¨å¹³æ•´æ”¾ç½®ï¼Œæ­£å¯¹æ‹æ‘„</li>
                <li>å·ç åŒºåŸŸæ¸…æ™°å¯è§ï¼Œé¿å…åå…‰</li>
                <li>å°½é‡è®©å½©ç¥¨å æ»¡ç”»é¢</li>
            </ul>
        </div>
        
        <div class="text-center mb-3">
            <canvas id="captureCanvas" style="display:none;"></canvas>
            <img id="capturedImage" class="camera-preview">
        </div>
        
        <div class="d-flex gap-2 mb-3" id="cameraControls">
            <label class="btn btn-camera flex-grow-1 m-0 py-3" style="cursor:pointer;">
                <i class="fas fa-camera me-2"></i>æ‹ç…§
                <input type="file" accept="image/*" capture="environment" id="cameraInput" style="display:none;" onchange="handleCameraCapture(this)">
            </label>
            <label class="btn btn-outline-secondary flex-grow-1 m-0 py-3" style="cursor:pointer;">
                <i class="fas fa-image me-2"></i>ä¸Šä¼ ç…§ç‰‡
                <input type="file" accept="image/*" id="imageInput" style="display:none;" onchange="handleImageSelect(this)">
            </label>
        </div>
        
        <div id="ocrResult" class="ocr-result" style="display:none;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="m-0 fw-bold"><i class="fas fa-list-check text-success me-2"></i>è¯†åˆ«ç»“æœ</h6>
                <span class="badge bg-primary" id="ocrCount">0 æ³¨</span>
            </div>
            <div id="ocrTickets"></div>
            <div class="bg-light p-3 rounded-3 mb-3">
                <div class="row g-2">
                    <div class="col-6"><label class="small text-muted">å¼€å§‹æœŸå·</label><input type="number" class="form-control" id="ocrStartTerm"></div>
                    <div class="col-6"><label class="small text-muted">ç»“æŸæœŸå·</label><input type="number" class="form-control" id="ocrEndTerm"></div>
                </div>
            </div>
            {% if user.enable_simulation %}
            <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="ocrSimCheck">
                <label class="form-check-label" for="ocrSimCheck"><i class="fas fa-gamepad text-primary me-1"></i>æ·»åŠ ä¸ºæ¨¡æ‹Ÿè´­å½©</label>
            </div>
            {% endif %}
            <button type="button" class="btn btn-success w-100" onclick="submitOcrTickets()"><i class="fas fa-check me-2"></i>ç¡®è®¤æ·»åŠ </button>
        </div>
      </div>
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // éšæœºå·ç ç”Ÿæˆå™¨ï¼ˆé¡µé¢æ¨¡å—ï¼‰
    let currentRandomReds = [];
    let currentRandomBlues = [];
    
    function generateRandomDisplay() {
        currentRandomReds = [];
        while(currentRandomReds.length < 5) {
            let n = Math.floor(Math.random() * 35) + 1;
            if(!currentRandomReds.includes(n)) currentRandomReds.push(n);
        }
        currentRandomReds.sort((a,b) => a - b);
        
        currentRandomBlues = [];
        while(currentRandomBlues.length < 2) {
            let n = Math.floor(Math.random() * 12) + 1;
            if(!currentRandomBlues.includes(n)) currentRandomBlues.push(n);
        }
        currentRandomBlues.sort((a,b) => a - b);
        
        // æ›´æ–°æ˜¾ç¤º
        currentRandomReds.forEach((n, i) => {
            document.getElementById('rand_r' + (i+1)).textContent = n.toString().padStart(2, '0');
        });
        currentRandomBlues.forEach((n, i) => {
            document.getElementById('rand_b' + (i+1)).textContent = n.toString().padStart(2, '0');
        });
    }
    
    function useRandomNumbers() {
        if(currentRandomReds.length === 0) {
            generateRandomDisplay();
        }
        // å¡«å……åˆ°æ·»åŠ è¡¨å•
        currentRandomReds.forEach((n, i) => {
            document.getElementById('r' + (i+1)).value = n.toString().padStart(2, '0');
        });
        currentRandomBlues.forEach((n, i) => {
            document.getElementById('b' + (i+1)).value = n.toString().padStart(2, '0');
        });
        // æ‰“å¼€æ·»åŠ å¼¹çª—
        new bootstrap.Modal(document.getElementById('addModal')).show();
    }
    
    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨ç”Ÿæˆä¸€ç»„
    document.addEventListener('DOMContentLoaded', function() {
        generateRandomDisplay();
    });

    // ç¼–è¾‘å½©ç¥¨æ¨¡æ€æ¡†
    function openEditModal(id, reds, blues, note, startTerm, endTerm, isSim) {
        document.getElementById('editTicketId').value = id;
        document.getElementById('editIsSimulation').value = isSim ? '1' : '0';
        document.getElementById('editNote').value = note;
        document.getElementById('editStartTerm').value = startTerm;
        document.getElementById('editEndTerm').value = endTerm;
        
        const redArr = reds.split(',');
        const blueArr = blues.split(',');
        redArr.forEach((n, i) => {
            document.getElementById('edit_r' + (i+1)).value = n;
        });
        blueArr.forEach((n, i) => {
            document.getElementById('edit_b' + (i+1)).value = n;
        });
        
        new bootstrap.Modal(document.getElementById('editModal')).show();
    }
    
    // ç¼–è¾‘è¡¨å•è¾“å…¥è·³è½¬
    document.addEventListener('DOMContentLoaded', function() {
        const editInputs = document.querySelectorAll('.edit-jump-input');
        editInputs.forEach((input, index) => {
            input.addEventListener('input', function() {
                if (this.value.length >= 2) {
                    let val = parseInt(this.value);
                    if (this.classList.contains('input-red') && (val < 1 || val > 35)) this.value = '';
                    if (this.classList.contains('input-blue') && (val < 1 || val > 12)) this.value = '';
                    if (this.value.length === 2 && editInputs[index + 1]) editInputs[index + 1].focus();
                }
            });
            input.addEventListener('keydown', function(e) { 
                if (e.key === "Backspace" && this.value.length === 0 && editInputs[index - 1]) editInputs[index - 1].focus(); 
            });
            input.addEventListener('focus', function() { this.select(); });
        });
    });

    // Serveré…± Key æ˜¾ç¤º/éšè—å¤„ç†
    let sckeyEdited = false;
    function showFullSckey() {
        const display = document.getElementById('sckeyDisplay');
        const full = document.getElementById('sckeyFull').value;
        if(full && !sckeyEdited) {
            display.value = full;
        }
    }
    function hideFullSckey() {
        const display = document.getElementById('sckeyDisplay');
        const full = document.getElementById('sckeyFull').value;
        // å¦‚æœç”¨æˆ·ä¿®æ”¹äº†ï¼Œè®°å½•æ–°å€¼
        if(display.value !== full && display.value.indexOf('******') === -1) {
            sckeyEdited = true;
            document.getElementById('sckeyInput').value = display.value;
        } else if(!sckeyEdited && full) {
            display.value = full.substring(0,3) + '******' + full.slice(-4);
        }
    }
    // è¡¨å•æäº¤å‰ç¡®ä¿å€¼æ­£ç¡®
    document.querySelector('form[action="/update_settings"]').addEventListener('submit', function() {
        const display = document.getElementById('sckeyDisplay');
        const input = document.getElementById('sckeyInput');
        if(display.value.indexOf('******') === -1) {
            input.value = display.value;
        }
    });

    // éšæœºç”Ÿæˆå·ç ï¼ˆæ·»åŠ å¼¹çª—å†…ï¼‰
    function generateRandom() {
        let reds = [];
        while(reds.length < 5) {
            let n = Math.floor(Math.random() * 35) + 1;
            if(!reds.includes(n)) reds.push(n);
        }
        reds.sort((a,b) => a - b);
        reds.forEach((n, i) => {
            document.getElementById('r' + (i+1)).value = n.toString().padStart(2, '0');
        });
        let blues = [];
        while(blues.length < 2) {
            let n = Math.floor(Math.random() * 12) + 1;
            if(!blues.includes(n)) blues.push(n);
        }
        blues.sort((a,b) => a - b);
        blues.forEach((n, i) => {
            document.getElementById('b' + (i+1)).value = n.toString().padStart(2, '0');
        });
    }

    // æ‹ç…§ç›¸å…³
    let ocrTicketsData = [];

    // æ‰‹æœºåŸç”Ÿç›¸æœºæ‹ç…§å¤„ç†
    function handleCameraCapture(input) {
        if(input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.getElementById('capturedImage');
                img.src = e.target.result;
                img.style.display = 'block';
                // éšè—æ‹ç…§å¼•å¯¼æç¤º
                document.getElementById('photoGuide').style.display = 'none';
                performOCR(e.target.result);
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    // ä¸Šä¼ ç…§ç‰‡å¤„ç†
    function handleImageSelect(input) {
        if(input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.getElementById('capturedImage');
                img.src = e.target.result;
                img.style.display = 'block';
                // éšè—æ‹ç…§å¼•å¯¼æç¤º
                document.getElementById('photoGuide').style.display = 'none';
                performOCR(e.target.result);
            };
            reader.readAsDataURL(input.files[0]);
        }
    }


    // OCRè¯†åˆ« - ä½¿ç”¨ Umi-OCR
    let ocrProgress = 0;
    
    function updateOcrProgressUI(status, percent) {
        const ocrResult = document.getElementById('ocrResult');
        if(!ocrResult) return;
        
        ocrResult.innerHTML = `
            <div class="ocr-loading">
                <div class="spinner-border text-primary mb-3" role="status"></div>
                <div class="text-center">
                    <div class="mb-2 text-muted">${status}</div>
                    <div class="progress" style="width:200px;margin:0 auto;height:6px;">
                        <div class="progress-bar" role="progressbar" style="width:${percent}%"></div>
                    </div>
                    <small class="text-muted mt-1">${percent}%</small>
                </div>
            </div>`;
    }
    
    function performOCR(imageData) {
        const ocrResult = document.getElementById('ocrResult');
        ocrResult.style.display = 'block';
        
        // æ˜¾ç¤ºè¿›åº¦
        updateOcrProgressUI('â­ æ­£åœ¨è¿æ¥ OCR æœåŠ¡...', 10);
        
        // æ¨¡æ‹Ÿè¿›åº¦æ›´æ–°
        let progress = 10;
        const progressSteps = [
            { at: 20, msg: 'ğŸ“· å›¾ç‰‡é¢„å¤„ç†ä¸­...' },
            { at: 35, msg: 'ğŸ” ç­–ç•¥ä¸€: æ ‡å‡†å¤„ç†è¯†åˆ«...' },
            { at: 50, msg: 'ğŸ” ç­–ç•¥äºŒ: é«˜å¯¹æ¯”åº¦è¯†åˆ«...' },
            { at: 65, msg: 'ğŸ” ç­–ç•¥ä¸‰: äºŒå€¼åŒ–å¤„ç†...' },
            { at: 80, msg: 'ğŸ” ç­–ç•¥å››: é™å™ªå¤„ç†...' },
            { at: 90, msg: 'âœ¨ é€‰æ‹©æœ€ä½³è¯†åˆ«ç»“æœ...' }
        ];
        let stepIndex = 0;
        const progressTimer = setInterval(() => {
            if(progress < 90) {
                progress += Math.random() * 10;
                if(progress > 90) progress = 90;
                // æ ¹æ®è¿›åº¦æ›´æ–°æç¤ºä¿¡æ¯
                while(stepIndex < progressSteps.length && progress >= progressSteps[stepIndex].at) {
                    updateOcrProgressUI(progressSteps[stepIndex].msg, Math.round(progress));
                    stepIndex++;
                }
                if(stepIndex === 0) {
                    updateOcrProgressUI('â­ æ­£åœ¨è¿æ¥ OCR æœåŠ¡...', Math.round(progress));
                }
            }
        }, 400);
        
        // è°ƒç”¨åç«¯ OCR æ¥å£
        fetch('/ocr', {
            method: 'POST',

            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ image: imageData })
        })
        .then(res => res.json())
        .then(data => {
            clearInterval(progressTimer);
            updateOcrProgressUI('âœ… è¯†åˆ«å®Œæˆï¼Œæ­£åœ¨è§£æ...', 100);
            
            console.log('[RapidOCR] åç«¯è¿”å›:', data);
            
            if(data.success) {
                console.log('[RapidOCR] è¯†åˆ«æ–‡æœ¬:\n', data.text);
                console.log('[RapidOCR] ä½¿ç”¨ç­–ç•¥:', data.strategy || 'é»˜è®¤');
                displayOcrResults({
                    tickets: data.tickets || [],
                    startTerm: data.startTerm,
                    termCount: data.termCount || 1,
                    needConfirm: data.needConfirm || false,
                    strategy: data.strategy || null
                });
            } else {
                console.error('[RapidOCR] è¯†åˆ«å¤±è´¥:', data.error);
                displayOcrResults({
                    tickets: [],
                    startTerm: null,
                    termCount: 1,
                    needConfirm: true,
                    errorMsg: data.error || 'è¯†åˆ«å¤±è´¥'
                });
            }
        })
        .catch(err => {
            clearInterval(progressTimer);
            console.error('[RapidOCR] è¯·æ±‚å¤±è´¥:', err);
            displayOcrResults({
                tickets: [],
                startTerm: null,
                termCount: 1,
                needConfirm: true,
                errorMsg: 'ç½‘ç»œè¯·æ±‚å¤±è´¥: ' + err.message
            });
        });
    }
    
    function displayOcrResults(parseResult) {
        const ocrResult = document.getElementById('ocrResult');
        const latestTerm = parseInt(document.getElementById('latestTerm').value) || 0;
        
        // ä½¿ç”¨è¯†åˆ«çš„æœŸå·ï¼Œå¦‚æœæ²¡è¯†åˆ«åˆ°åˆ™ç”¨æœ€æ–°æœŸ+1
        let tickets, startTerm, endTerm;
        if(Array.isArray(parseResult)) {
            // å…¼å®¹æ—§çš„è°ƒç”¨æ–¹å¼
            tickets = parseResult;
            startTerm = latestTerm + 1;
            endTerm = latestTerm + 1;
        } else {
            tickets = parseResult.tickets;
            startTerm = parseResult.startTerm || (latestTerm + 1);
            endTerm = startTerm + (parseResult.termCount || 1) - 1;
        }
        
        let html = `
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="m-0 fw-bold"><i class="fas fa-list-check text-success me-2"></i>è¯†åˆ«ç»“æœ</h6>
                <div>
                    ${parseResult.strategy ? '<span class="badge bg-info me-2" title="ä½¿ç”¨çš„è¯†åˆ«ç­–ç•¥"><i class="fas fa-magic me-1"></i>' + parseResult.strategy + '</span>' : ''}
                    <span class="badge bg-primary" id="ocrCount">${tickets.length} æ³¨</span>
                </div>
            </div>
            <div id="ocrTickets">`;        
        if(tickets.length > 0) {
            tickets.forEach((t, idx) => {
                html += createOcrTicketRowHtml(idx, t.reds, t.blues);
            });
        } else {
            // æ²¡æœ‰è¯†åˆ«åˆ°ï¼Œæ·»åŠ ç©ºè¡Œè®©ç”¨æˆ·æ‰‹åŠ¨è¾“å…¥
            html += createOcrTicketRowHtml(0, ['','','','',''], ['','']);
        }
        
        html += `</div>
            <button type="button" class="btn btn-outline-primary btn-sm w-100 mb-3" onclick="addOcrTicketRow()"><i class="fas fa-plus me-2"></i>æ·»åŠ æ›´å¤šå½©ç¥¨</button>
            ${parseResult.errorMsg ? '<div class="alert alert-danger py-2 mb-3"><i class="fas fa-exclamation-circle me-2"></i><strong>è¯†åˆ«å¤±è´¥ï¼š</strong>' + parseResult.errorMsg + 'ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥</div>' : ''}
            <div class="alert alert-info py-2 mb-3"><i class="fas fa-info-circle me-2"></i><strong>æç¤ºï¼š</strong>è¯·ä»”ç»†æ ¸å¯¹è¯†åˆ«ç»“æœï¼Œç¡®ä¿å·ç å’ŒæœŸæ•°æ­£ç¡®</div>
            ${parseResult.needConfirm ? '<div class="alert alert-warning py-2 mb-3"><i class="fas fa-exclamation-triangle me-2"></i><strong>æ³¨æ„ï¼š</strong>æœªè‡ªåŠ¨è¯†åˆ«åˆ°æœŸå·ï¼Œè¯·æ‰‹åŠ¨å¡«å†™å¼€å§‹æœŸå·</div>' : ''}
            <div class="bg-light p-3 rounded-3 mb-3">
                <div class="row g-2">
                    <div class="col-4"><label class="small text-muted">å¼€å§‹æœŸå·</label><input type="number" class="form-control" id="ocrStartTerm" value="${startTerm}" onchange="updateOcrEndTerm()"></div>
                    <div class="col-4"><label class="small text-muted">è´­ä¹°æœŸæ•°</label><input type="number" class="form-control" id="ocrTermCount" value="${parseResult.termCount || 1}" min="1" max="30" onchange="updateOcrEndTerm()"></div>
                    <div class="col-4"><label class="small text-muted">ç»“æŸæœŸå·</label><input type="number" class="form-control bg-white" id="ocrEndTerm" value="${endTerm}" readonly></div>
                </div>
            </div>
            <div class="form-check mb-3" id="ocrSimCheckDiv">
                <input class="form-check-input" type="checkbox" id="ocrSimCheck">
                <label class="form-check-label" for="ocrSimCheck"><i class="fas fa-gamepad text-primary me-1"></i>æ·»åŠ ä¸ºæ¨¡æ‹Ÿè´­å½©</label>
            </div>
            <button type="button" class="btn btn-success w-100" onclick="submitOcrTickets()"><i class="fas fa-check me-2"></i>ç¡®è®¤æ·»åŠ </button>`;
        
        ocrResult.innerHTML = html;
        // ç»‘å®šOCRè¾“å…¥æ¡†è·³è½¬
        bindOcrInputJump();
    }
    
    function createOcrTicketRowHtml(idx, reds, blues) {
        return `
            <div class="ocr-ticket">
                <div class="d-flex gap-2 mb-2">
                    <span class="badge bg-secondary">ç¬¬${idx+1}æ³¨</span>
                    <button type="button" class="btn btn-sm btn-outline-danger ms-auto" onclick="this.parentElement.parentElement.remove();updateOcrCount();">&times;</button>
                </div>
                <div class="row g-1 mb-2">
                    <div class="col"><input type="tel" class="form-control form-control-sm text-center ocr-input" value="${reds[0] || ''}" placeholder="01" maxlength="2" data-type="red"></div>
                    <div class="col"><input type="tel" class="form-control form-control-sm text-center ocr-input" value="${reds[1] || ''}" placeholder="02" maxlength="2" data-type="red"></div>
                    <div class="col"><input type="tel" class="form-control form-control-sm text-center ocr-input" value="${reds[2] || ''}" placeholder="03" maxlength="2" data-type="red"></div>
                    <div class="col"><input type="tel" class="form-control form-control-sm text-center ocr-input" value="${reds[3] || ''}" placeholder="04" maxlength="2" data-type="red"></div>
                    <div class="col"><input type="tel" class="form-control form-control-sm text-center ocr-input" value="${reds[4] || ''}" placeholder="05" maxlength="2" data-type="red"></div>
                    <div class="col-auto text-muted">+</div>
                    <div class="col"><input type="tel" class="form-control form-control-sm text-center ocr-input" value="${blues[0] || ''}" placeholder="01" maxlength="2" data-type="blue" style="background:#f0f8ff;"></div>
                    <div class="col"><input type="tel" class="form-control form-control-sm text-center ocr-input" value="${blues[1] || ''}" placeholder="02" maxlength="2" data-type="blue" style="background:#f0f8ff;"></div>
                </div>
            </div>`;
    }
    
    function bindOcrInputJump() {
        const ocrInputs = document.querySelectorAll('.ocr-input');
        ocrInputs.forEach((input, index) => {
            input.addEventListener('input', function() {
                if(this.value.length >= 2 && ocrInputs[index + 1]) {
                    ocrInputs[index + 1].focus();
                }
            });
            input.addEventListener('keydown', function(e) {
                if(e.key === 'Backspace' && this.value.length === 0 && ocrInputs[index - 1]) {
                    ocrInputs[index - 1].focus();
                }
            });
            input.addEventListener('focus', function() { this.select(); });
        });
    }

    function addOcrTicketRow() {
        const container = document.getElementById('ocrTickets');
        const idx = container.children.length;
        const div = document.createElement('div');
        div.className = 'ocr-ticket';
        div.innerHTML = `
            <div class="d-flex gap-2 mb-2">
                <span class="badge bg-secondary">ç¬¬${idx+1}æ³¨</span>
                <button type="button" class="btn btn-sm btn-outline-danger ms-auto" onclick="this.parentElement.parentElement.remove();updateOcrCount();">&times;</button>
            </div>
            <div class="row g-1 mb-2">
                <div class="col"><input type="tel" class="form-control form-control-sm text-center ocr-input" placeholder="01" maxlength="2" data-type="red"></div>
                <div class="col"><input type="tel" class="form-control form-control-sm text-center ocr-input" placeholder="02" maxlength="2" data-type="red"></div>
                <div class="col"><input type="tel" class="form-control form-control-sm text-center ocr-input" placeholder="03" maxlength="2" data-type="red"></div>
                <div class="col"><input type="tel" class="form-control form-control-sm text-center ocr-input" placeholder="04" maxlength="2" data-type="red"></div>
                <div class="col"><input type="tel" class="form-control form-control-sm text-center ocr-input" placeholder="05" maxlength="2" data-type="red"></div>
                <div class="col-auto text-muted">+</div>
                <div class="col"><input type="tel" class="form-control form-control-sm text-center ocr-input" placeholder="01" maxlength="2" data-type="blue" style="background:#f0f8ff;"></div>
                <div class="col"><input type="tel" class="form-control form-control-sm text-center ocr-input" placeholder="02" maxlength="2" data-type="blue" style="background:#f0f8ff;"></div>
            </div>
        `;
        container.appendChild(div);
        updateOcrCount();
        // é‡æ–°ç»‘å®šè·³è½¬äº‹ä»¶
        bindOcrInputJump();
    }

    function updateOcrCount() {
        const count = document.getElementById('ocrTickets').children.length;
        document.getElementById('ocrCount').textContent = count + ' æ³¨';
    }
    
    function updateOcrEndTerm() {
        const startTerm = parseInt(document.getElementById('ocrStartTerm').value) || 0;
        const termCount = parseInt(document.getElementById('ocrTermCount').value) || 1;
        document.getElementById('ocrEndTerm').value = startTerm + termCount - 1;
    }

    function submitOcrTickets() {
        const tickets = [];
        const rows = document.getElementById('ocrTickets').children;
        let hasError = false;
        
        for(let row of rows) {
            const inputs = row.querySelectorAll('input');
            const reds = [];
            const blues = [];
            inputs.forEach(inp => {
                if(inp.dataset.type === 'red' && inp.value) reds.push(inp.value.padStart(2,'0'));
                if(inp.dataset.type === 'blue' && inp.value) blues.push(inp.value.padStart(2,'0'));
            });
            
            // éªŒè¯å·ç æ•°é‡
            if(reds.length !== 5 || blues.length !== 2) {
                continue; // è·³è¿‡ä¸å®Œæ•´çš„è¡Œ
            }
            
            // éªŒè¯çº¢çƒèŒƒå›´ 1-35
            const redNums = reds.map(r => parseInt(r));
            const invalidRed = redNums.some(n => isNaN(n) || n < 1 || n > 35);
            if(invalidRed) {
                hasError = true;
                alert('çº¢çƒå·ç å¿…é¡»åœ¨ 01-35 ä¹‹é—´');
                return;
            }
            
            // éªŒè¯çº¢çƒä¸é‡å¤
            if(new Set(redNums).size !== 5) {
                hasError = true;
                alert('çº¢çƒå·ç ä¸èƒ½é‡å¤');
                return;
            }
            
            // éªŒè¯è“çƒèŒƒå›´ 1-12
            const blueNums = blues.map(b => parseInt(b));
            const invalidBlue = blueNums.some(n => isNaN(n) || n < 1 || n > 12);
            if(invalidBlue) {
                hasError = true;
                alert('è“çƒå·ç å¿…é¡»åœ¨ 01-12 ä¹‹é—´');
                return;
            }
            
            // éªŒè¯è“çƒä¸é‡å¤
            if(new Set(blueNums).size !== 2) {
                hasError = true;
                alert('è“çƒå·ç ä¸èƒ½é‡å¤');
                return;
            }
            
            tickets.push({ reds: reds.join(','), blues: blues.join(','), note: 'æ‹ç…§æ·»åŠ ' });
        }
        
        if(tickets.length === 0) {
            alert('è¯·å¡«å†™å®Œæ•´çš„å½©ç¥¨å·ç ');
            return;
        }
        
        const startTerm = parseInt(document.getElementById('ocrStartTerm').value);
        const termCount = parseInt(document.getElementById('ocrTermCount').value) || 1;
        const endTerm = startTerm + termCount - 1;
        
        // éªŒè¯æœŸå·
        const latestTermVal = parseInt(document.getElementById('latestTerm').value) || 24000;
        if(isNaN(startTerm) || startTerm <= 0) {
            alert('è¯·å¡«å†™æœ‰æ•ˆçš„å¼€å§‹æœŸå·');
            return;
        }
        
        // æ£€æŸ¥æœŸå·æ˜¯å¦åœ¨åˆç†èŒƒå›´å†…ï¼ˆ23000-26000ï¼‰
        if(startTerm < 23000 || startTerm > 26000) {
            if(!confirm('æœŸå· ' + startTerm + ' ä¼¼ä¹ä¸åœ¨åˆç†èŒƒå›´å†…(23000-26000)ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ')) {
                return;
            }
        }
        
        const isSim = document.getElementById('ocrSimCheck') ? document.getElementById('ocrSimCheck').checked : false;
        
        fetch('/add_batch', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                tickets: tickets,
                start_term: startTerm,
                end_term: endTerm,
                is_simulation: isSim
            })
        }).then(res => res.json()).then(data => {
            if(data.success) {
                alert('æˆåŠŸæ·»åŠ  ' + data.added + ' æ³¨å½©ç¥¨');
                location.reload();
            } else {
                alert('æ·»åŠ å¤±è´¥: ' + data.error);
            }
        }).catch(err => {
            alert('ç½‘ç»œé”™è¯¯: ' + err.message);
        });
    }

    // å…³é—­æ¨¡æ€æ¡†æ—¶é‡ç½®ç•Œé¢
    document.getElementById('cameraModal').addEventListener('hidden.bs.modal', function() {
        document.getElementById('ocrResult').style.display = 'none';
        document.getElementById('capturedImage').style.display = 'none';
        document.getElementById('photoGuide').style.display = 'block';
        document.getElementById('ocrTickets').innerHTML = '';
        // é‡ç½®æ–‡ä»¶è¾“å…¥æ¡†
        document.getElementById('cameraInput').value = '';
        document.getElementById('imageInput').value = '';
    });

    document.addEventListener("DOMContentLoaded", function() {
        const inputs = document.querySelectorAll('.jump-input');
        inputs.forEach((input, index) => {
            input.addEventListener('input', function() {
                if (this.value.length >= 2) {
                    let val = parseInt(this.value);
                    if (this.classList.contains('input-red') && (val < 1 || val > 35)) this.value = ''; 
                    if (this.classList.contains('input-blue') && (val < 1 || val > 12)) this.value = ''; 
                    if (this.value.length === 2 && inputs[index + 1]) inputs[index + 1].focus();
                }
            });
            input.addEventListener('keydown', function(e) { if (e.key === "Backspace" && this.value.length === 0 && inputs[index - 1]) inputs[index - 1].focus(); });
            input.addEventListener('focus', function() { this.select(); });
        });
        const latestTermStr = document.getElementById('latestTerm').value;
        const startIn = document.getElementById('startTerm'); const endIn = document.getElementById('endTerm'); const countIn = document.getElementById('termCount');
        document.getElementById('addModal').addEventListener('show.bs.modal', function () {
            if (latestTermStr && parseInt(latestTermStr) > 0) startIn.value = parseInt(latestTermStr) + 1;
            countIn.value = 1; updateEnd();
        });
        function updateEnd() { endIn.value = (parseInt(startIn.value) || 0) + (parseInt(countIn.value) || 1) - 1; }
        startIn.addEventListener('input', updateEnd); countIn.addEventListener('input', updateEnd);
    });
</script>
<!-- æ·»åŠ æ›´å¤šæ³¨æŒ‰é’® -->
<script>
    // ç»™OCRç»“æœæ·»åŠ "æ·»åŠ æ›´å¤š"æŒ‰é’®
    document.addEventListener('DOMContentLoaded', function() {
        const ocrResult = document.getElementById('ocrResult');
        if(ocrResult) {
            const addBtn = document.createElement('button');
            addBtn.type = 'button';
            addBtn.className = 'btn btn-outline-primary btn-sm w-100 mb-3';
            addBtn.innerHTML = '<i class="fas fa-plus me-2"></i>æ·»åŠ æ›´å¤šå½©ç¥¨';
            addBtn.onclick = addOcrTicketRow;
            ocrResult.insertBefore(addBtn, document.getElementById('ocrTickets').nextSibling);
        }
    });
</script>
</body>
</html>